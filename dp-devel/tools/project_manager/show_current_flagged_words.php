<?php
$relPath="./../../pinc/";
include_once($relPath.'site_vars.php');
include_once($relPath.'dp_main.inc');
include_once($relPath.'project_states.inc');
include_once($relPath.'stages.inc');
include_once($relPath.'Project.inc');
include_once('./post_files.inc');
include_once($relPath.'word_checker.inc');

set_time_limit(0); // no time limit

$projectid = $_GET["projectid"];

// if format is 'text', all words and frequencies will be printed
// if format is not 'text', an HTML page is displayed
$format = $_GET["format"];

// anything that appears in the list less than this number
// won't show up in the list
$minFreq = array_get($_GET, 'minFreq', 10);

// load the project -- needed for the languages
$project = new Project ($projectid);
$languages = preg_split('/ with /', $project->language);

// get the latest project text of all pages up to last possible round
$last_possible_round = get_Round_for_round_number(MAX_NUM_PAGE_EDITING_ROUNDS);
$pages_res = page_info_query($projectid,$last_possible_round->id,'LE');
$all_pages_text = join_proofed_text($projectid,$pages_res,false,false,'');

// normalize the text for processing
#$all_pages_text=preg_replace("/-+File: .*?----+/",'',$all_pages_text);
$all_pages_text = preg_replace("/^-+File: .*$/m",'',$all_pages_text);

// now run it through the aspell checker
// get_bad_words_from_text returns an array of misspelled words, including duplicate
// words. To generate a frequency count we need only count them
$wrongWords = get_bad_words_from_text($all_pages_text,$projectid,'all',$languages);
if(!is_array($wrongWords)) {
    echo "Error running aspell: $wrongWords";
    exit;
}

// get the word frequencies
$wordCount = generate_frequencies($wrongWords);

// sort the list by frequency and reverse it
arsort($wordCount);

// if the user wants the list in text-only mode
if($format == "text") {
    // freq side
    foreach( $wordCount as $word => $freq) {
        echo "$word - $freq\n";
    }
    exit;
}

?>
<html>
<head>
<title>Project Word List</title>
</head>
<body>
<p>Below are words that have been flagged by the spellchecker as invalid but appear frequently in the project. The list was generated by accessing the text of the book from the most recent round of each page and running it through the spellchecker using both the system and the project dictionaries. Review the list and consider adding frequently used valid words to the project's valid word list by copying and pasting them into the Valid Words box when editing the project.</p>

<?
$cutoffOptions = array(0,2,5,10,25,50,100,150);
$cutoffString = "";
foreach($cutoffOptions as $cutoff) {
    if($cutoff == $minFreq)
        $cutoffString .= "$cutoff | ";
    else
        $cutoffString .= "<a href='generate_dict_suggestions.php?projectid=$projectid&amp;minFreq=$cutoff'>$cutoff</a> | ";
}
$cutoffString = preg_replace("/ \| $/","",$cutoffString);
?>
<p>Words that appear fewer than <?php echo $minFreq;?> times are not shown. Other cutoff options are available: <?PHP echo $cutoffString; ?>.</p>
<p>You can also <a href="generate_dict_suggestions.php?projectid=<?PHP echo $projectid; ?>&amp;format=text">download</a> a copy of the word list with frequencies for offline analysis. When adding the final list to the input box on the Edit Project page, the frequencies can be left in and the system will remove them.</p>

<p><b>Note:</b> Word that have been already saved in the project dictionary will not appear here as they are already considered valid by the spellchecker. Take care not to overwrite these words when pasting additional words in the box.</p>

<table>
<tr><th>Frequency</th><th>Word</th></tr>

<?php
// we'll do it in a table so project managers can copy-paste
// the values list into the accept textarea
// words printed
$words_printed = 0;

// freq side
echo "<tr><td><hr>";
foreach( $wordCount as $word => $freq ) {
    if($freq < $minFreq) break;
    echo "$freq<br>\n";
    $words_printed++;
}
echo "</td>\n";

// word side
echo "<td><hr>";
foreach( $wordCount as $word => $freq ) {
    if($freq < $minFreq) break;
    echo "$word<br>\n";
}

?>

</td></tr></table>

<?
    $freqString = _('%d additional words with frequency less than %d were found and not shown.');
    echo '<p>' . sprintf($freqString,sizeof($wordCount)-$words_printed,$minFreq) . '</p>';

// vim: sw=4 ts=4 expandtab
?>
